---
import PasswordMeter from "../ui/PasswordMeter.astro";
import EmailInput from "../ui/EmailInput.astro";
import ValidationButton from "../ui/ValidationButton.astro";
import UsernameInput from "../ui/UsernameInput.astro";

export interface Props {
  buttonText: string;
}

const { buttonText } = Astro.props;

---

<form
  id="form-enter-auth"
  class="d-flex flex-column flex-center form"
  autocomplete="off"
  onsubmit="return false"
>
  <UsernameInput />
  <EmailInput />
  <PasswordMeter />
  <ValidationButton buttonText={buttonText} />
</form>

<style>
  #form-enter-auth {
    padding: 25px;
    border: 1px solid rgb(218, 218, 218);
    box-shadow: 0px 0px 5px gray;
    border-radius: 10px;
    background-color: white;
  }
</style>

<script>
  function sendAuthData() {
    const formData = new FormData(form);

    fetch("http://localhost:1337/api/auth/local/register", {
      method: "post",
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(Object.fromEntries(formData))
    })
    .then((response) => {
      return (response.json()
        .then((data) => {
          document.location.href = "/home"

          document.cookie = `Authorization=Bearer ${data.jwt }`;
        })  
      );
    })

  };

  const form = document.getElementById("form-enter-auth") as HTMLFormElement;

  form.addEventListener("submit", sendAuthData, false);

</script>